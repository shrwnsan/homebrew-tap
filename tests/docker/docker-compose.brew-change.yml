# Docker Compose configuration for brew-change testing
# Provides multiple scenarios and environments for comprehensive testing

version: '3.8'

services:
  # Main testing environment
  brew-change-test:
    build:
      context: ..
      dockerfile: tests/docker/Dockerfile.test-ubuntu
    container_name: brew-change-test
    environment:
      - BREW_CHANGE_DEBUG=1
      - BREW_CHANGE_JOBS=4
    volumes:
      - ../bin:/home/brewtest/brew-change/bin:ro
      - ../lib:/home/brewtest/brew-change/lib:ro
      - ./results:/home/brewtest/results
    command: ["/home/brewtest/test.sh"]
    networks:
      - brew-change-net

  # Performance testing environment
  brew-change-perf:
    build:
      context: ..
      dockerfile: tests/docker/Dockerfile.test-ubuntu
    container_name: brew-change-perf
    environment:
      - BREW_CHANGE_JOBS=8
      - BREW_CHANGE_DEBUG=0
    volumes:
      - ../bin:/home/brewtest/brew-change/bin:ro
      - ../lib:/home/brewtest/brew-change/lib:ro
      - ./performance:/home/brewtest/performance
    command: >
      bash -c "
        echo '=== Performance Tests ===' &&
        time /home/brewtest/brew-change/bin/brew-change -a > /home/brewtest/performance/output.log 2>&1 &&
        echo '=== System Resources ===' &&
        cat /proc/meminfo | head -5 &&
        uptime &&
        echo '=== Output Analysis ===' &&
        wc -l /home/brewtest/performance/output.log &&
        grep -c '---' /home/brewtest/performance/output.log || echo 'No separators found'
      "
    networks:
      - brew-change-net

  # Minimal Alpine environment
  alpine-minimal:
    image: alpine:3.19
    container_name: alpine-minimal
    environment:
      - BREW_CHANGE_JOBS=2
    volumes:
      - ../bin:/usr/local/bin:ro
      - ../lib:/usr/local/lib/brew-change:ro
      - ./minimal:/results
    command: >
      sh -c "
        apk add --no-cache bash curl jq git procps &&
        echo '=== Minimal Environment Test ===' &&
        /usr/local/bin/brew-change --help > /results/help.txt 2>&1 &&
        echo 'Help output size:' && wc -l /results/help.txt
      "
    networks:
      - brew-change-net

  # Network simulation (limited connectivity)
  network-limited:
    build:
      context: ..
      dockerfile: tests/docker/Dockerfile.test-ubuntu
    container_name: network-limited
    environment:
      - BREW_CHANGE_MAX_RETRIES=1
      - BREW_CHANGE_DEBUG=1
    volumes:
      - ../bin:/home/brewtest/brew-change/bin:ro
      - ../lib:/home/brewtest/brew-change/lib:ro
      - ./network:/results
    command: >
      bash -c "
        echo '=== Network Timeout Tests ===' &&
        echo 'Testing with timeout scenarios...' &&
        timeout 10s /home/brewtest/brew-change/bin/brew-change nonexistent-package-12345 > /results/timeout.txt 2>&1 || echo 'Timeout test completed' &&
        echo 'Network test completed'
      "
    networks:
      - brew-change-net

networks:
  brew-change-net:
    driver: bridge
    ipam:
      driver: default

volumes:
  results:
    driver: local
  performance:
    driver: local
  minimal:
    driver: local
  network:
    driver: local